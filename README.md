# React Web Bakery

Aplicación React + Vite con Supabase como backend (autenticación, base de datos y API REST). Se han implementado roles y gestión de pedidos.

## Tecnologías
- React 19
- Vite 7
- Supabase (DB Postgres + Auth)
- Zustand (estado de autenticación)
- Bootstrap 5 (estilos)
- Karma + Jasmine (tests unitarios)

## Esquema de Datos
Tablas principales en Supabase/Postgres:

```
user_profile (
	user_id UUID PRIMARY KEY,
	display_name TEXT,
	role TEXT CHECK (role IN ('admin','vendedor','cliente')),
	created_at TIMESTAMPTZ DEFAULT now()
)

orders (
	id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	user_id UUID REFERENCES user_profile(user_id) ON DELETE CASCADE,
	status TEXT CHECK (status IN ('pending','paid','cancelled')),
	subtotal_cents INT NOT NULL DEFAULT 0,
	discount_cents INT NOT NULL DEFAULT 0,
	total_cents INT NOT NULL DEFAULT 0,
	coupon_code TEXT NULL,
	created_at TIMESTAMPTZ DEFAULT now()
)
```

Relación: un `user_profile` tiene muchos `orders`.

### Diagrama (simplificado)
```
 user_profile                      orders
 -------------                     -----------------------------
 user_id (PK) <------------------  user_id (FK)
 display_name                      id (PK)
 role                              status
 created_at                        subtotal_cents
																	 discount_cents
																	 total_cents
																	 coupon_code
																	 created_at
```

### Estados y Transiciones
Estados permitidos: `pending`, `paid`, `cancelled`.
- pending -> paid | cancelled
- paid -> cancelled
- cancelled -> (sin cambios)

Se migran automáticamente estados legacy si aún existen (p.ej. `pendiente`, `completado`).

### Reglas de Cálculo
`total_cents = subtotal_cents - discount_cents` con validaciones:
- Subtotal >= 0
- Descuento >= 0
- Descuento <= Subtotal

## Lógica de Roles
- Admin: CRUD completo de pedidos.
- Vendedor: solo visualización de listado (sin edición/borrado/creación).
- Cliente: redirigido fuera de la vista de administración.

## Tests
Localizados en `src/__tests__/`. Se testean funciones puras de `ordersUtils` (cálculo, validaciones, transiciones).

Ejecutar tests:
```bash
npm test
```

## Scripts
```bash
npm run dev      # Desarrollo
npm run build    # Build producción
npm run preview  # Previsualizar build
npm test         # Ejecutar Karma/Jasmine
```

## Próximos Pasos
- Documentar endpoints REST si se crean funciones RPC/Edge en Supabase.
- Añadir capa de seguridad server-side para roles en RLS (Row Level Security).
- Extender esquema para productos y detalles de pedido.

